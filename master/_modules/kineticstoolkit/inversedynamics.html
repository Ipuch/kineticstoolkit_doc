
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kineticstoolkit.inversedynamics &mdash; Kinetics Toolkit</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx-thebe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/stable.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/togglebutton.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
        <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />


 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
            <a href="../../index.html">
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started_ktk.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ktk_in_depth.html">In depth</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../99_api_reference/01_classes.html">Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../99_api_reference/02_functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../99_api_reference/03_modules.html">Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/felixchenier/kineticstoolkit">GitHub repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>kineticstoolkit.inversedynamics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for kineticstoolkit.inversedynamics</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2020 Félix Chénier</span>

<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>

<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provide functions to calculate inverse dynamics.</span>

<span class="sd">Warning</span>
<span class="sd">-------</span>
<span class="sd">This module is currently experimental and its API and behaviour could be</span>
<span class="sd">modified in the future.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Félix Chénier&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) 2020 Félix Chénier&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;chenier.felix@uqam.ca&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;Apache 2.0&quot;</span>


<span class="kn">import</span> <span class="nn">kineticstoolkit.filters</span>
<span class="kn">from</span> <span class="nn">kineticstoolkit.decorators</span> <span class="kn">import</span> <span class="n">unstable</span><span class="p">,</span> <span class="n">directory</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">kineticstoolkit</span> <span class="kn">import</span> <span class="n">TimeSeries</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">default_filter_fc</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Hz</span>
<span class="n">default_filter_order</span> <span class="o">=</span> <span class="mi">2</span>


<div class="viewcode-block" id="get_anthropometrics"><a class="viewcode-back" href="../../api/kineticstoolkit.inversedynamics.get_anthropometrics.html#kineticstoolkit.inversedynamics.get_anthropometrics">[docs]</a><span class="nd">@unstable</span>
<span class="k">def</span> <span class="nf">get_anthropometrics</span><span class="p">(</span><span class="n">segment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">total_mass</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get anthropometric values for a given segment name.</span>

<span class="sd">    For the moment, only this table is available:</span>

<span class="sd">    D. A. Winter, Biomechanics and Motor Control of Human Movement,</span>
<span class="sd">    4th ed. University of Waterloo, Waterloo, Ontario, Canada,</span>
<span class="sd">    John Wiley &amp; Sons, 2009.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    segment_name</span>
<span class="sd">        The name of the segment, either:</span>

<span class="sd">        - &#39;Hand&#39; (wrist axis to knuckle II of middle finger)</span>
<span class="sd">        - &#39;Forearm&#39; (elbow axis to ulnar styloid)</span>
<span class="sd">        - &#39;UpperArm&#39; (glenohumeral axis to elbow axis)</span>
<span class="sd">        - &#39;ForearmHand&#39; (elbow axis to ulnar styloid)</span>
<span class="sd">        - &#39;TotalArm&#39; (glenohumeral joint to ulnar styloid)</span>
<span class="sd">        - &#39;Foot&#39; (lateral malleolus to head metatarsal II)</span>
<span class="sd">        - &#39;Leg&#39; (femoral condyles to medial malleolus)</span>
<span class="sd">        - &#39;Thigh&#39; (greater trochanter to femoral condyles)</span>
<span class="sd">        - &#39;FootLeg&#39; (fomeral condyles to medial malleolus)</span>
<span class="sd">        - &#39;TotalLeg&#39; (greater trochanter to medial malleolus)</span>
<span class="sd">        - &#39;TrunkHeadNeck&#39; (greater trochanter to glenohumeral joint)</span>
<span class="sd">        - &#39;HeadArmsTrunk&#39; (greater trochanter to glenohumeral joint)</span>

<span class="sd">    total_mass</span>
<span class="sd">        The total mass of the person, in kg.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, float]</span>
<span class="sd">        A dict with the following keys:</span>

<span class="sd">        - &#39;Mass&#39; : Mass of the segment, in kg.</span>
<span class="sd">        - &#39;COMProximalRatio&#39; : Distance between the segment&#39;s center of</span>
<span class="sd">          mass and the proximal joint, as a ratio of the distance between</span>
<span class="sd">          both joints.</span>
<span class="sd">        - &#39;COMDistalRatio&#39; : Distance between the segment&#39;s center of mass</span>
<span class="sd">          and the distal joint, as a ratio of the distance between</span>
<span class="sd">          both joints.</span>
<span class="sd">        - &#39;GyrationCOMRatio&#39;: Radius of gyration around the segment&#39;s center</span>
<span class="sd">          of mass, as a ratio of the distance between both joints.</span>
<span class="sd">        - &#39;GyrationProximalRatio&#39;: Radius of gyration around the segment&#39;s</span>
<span class="sd">           proximal joint, as a ratio of the distance between both joints.</span>
<span class="sd">        - &#39;GyrationDistalRatio&#39;: Radius of gyration around the segment&#39;s</span>
<span class="sd">           distal joint, as a ratio of the distance between both joints.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;Hand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.006</span><span class="p">,</span> <span class="mf">0.506</span><span class="p">,</span> <span class="mf">0.494</span><span class="p">,</span> <span class="mf">0.297</span><span class="p">,</span> <span class="mf">0.587</span><span class="p">,</span> <span class="mf">0.577</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;Forearm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.016</span><span class="p">,</span> <span class="mf">0.430</span><span class="p">,</span> <span class="mf">0.570</span><span class="p">,</span> <span class="mf">0.303</span><span class="p">,</span> <span class="mf">0.526</span><span class="p">,</span> <span class="mf">0.647</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;UpperArm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.028</span><span class="p">,</span> <span class="mf">0.436</span><span class="p">,</span> <span class="mf">0.564</span><span class="p">,</span> <span class="mf">0.322</span><span class="p">,</span> <span class="mf">0.542</span><span class="p">,</span> <span class="mf">0.645</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;ForearmHand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.022</span><span class="p">,</span> <span class="mf">0.682</span><span class="p">,</span> <span class="mf">0.318</span><span class="p">,</span> <span class="mf">0.468</span><span class="p">,</span> <span class="mf">0.827</span><span class="p">,</span> <span class="mf">0.565</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;TotalArm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.530</span><span class="p">,</span> <span class="mf">0.470</span><span class="p">,</span> <span class="mf">0.368</span><span class="p">,</span> <span class="mf">0.645</span><span class="p">,</span> <span class="mf">0.596</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;Foot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0145</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.475</span><span class="p">,</span> <span class="mf">0.690</span><span class="p">,</span> <span class="mf">0.690</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;Leg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0465</span><span class="p">,</span> <span class="mf">0.433</span><span class="p">,</span> <span class="mf">0.567</span><span class="p">,</span> <span class="mf">0.302</span><span class="p">,</span> <span class="mf">0.528</span><span class="p">,</span> <span class="mf">0.643</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;Thigh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.433</span><span class="p">,</span> <span class="mf">0.567</span><span class="p">,</span> <span class="mf">0.323</span><span class="p">,</span> <span class="mf">0.540</span><span class="p">,</span> <span class="mf">0.653</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;FootLeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.061</span><span class="p">,</span> <span class="mf">0.606</span><span class="p">,</span> <span class="mf">0.394</span><span class="p">,</span> <span class="mf">0.416</span><span class="p">,</span> <span class="mf">0.735</span><span class="p">,</span> <span class="mf">0.572</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;TotalLeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.161</span><span class="p">,</span> <span class="mf">0.447</span><span class="p">,</span> <span class="mf">0.553</span><span class="p">,</span> <span class="mf">0.326</span><span class="p">,</span> <span class="mf">0.560</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;TrunkHeadNeck&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.578</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.503</span><span class="p">,</span> <span class="mf">0.830</span><span class="p">,</span> <span class="mf">0.607</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;HeadArmsTrunk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.678</span><span class="p">,</span> <span class="mf">0.626</span><span class="p">,</span> <span class="mf">0.374</span><span class="p">,</span> <span class="mf">0.496</span><span class="p">,</span> <span class="mf">0.798</span><span class="p">,</span> <span class="mf">0.621</span><span class="p">]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">segment_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_mass</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;COMProximalRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">segment_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;COMDistalRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">segment_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;GyrationCOMRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">segment_name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;GyrationProximalRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">segment_name</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;GyrationDistalRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">segment_name</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The segment &quot;</span><span class="si">{</span><span class="n">segment_name</span><span class="si">}</span><span class="s1">&quot; is not available.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_com_position"><a class="viewcode-back" href="../../api/kineticstoolkit.inversedynamics.calculate_com_position.html#kineticstoolkit.inversedynamics.calculate_com_position">[docs]</a><span class="nd">@unstable</span>
<span class="k">def</span> <span class="nf">calculate_com_position</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span> <span class="n">inertial_constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TimeSeries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the position of the segment&#39;s center of mass.</span>

<span class="sd">    Adds the data key &#39;COMPosition&#39; to the TimeSeries based on the</span>
<span class="sd">    &#39;COMProximalRatio&#39; key of the dict inertial_constants.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts</span>
<span class="sd">        A TimeSeries with the following data keys:</span>

<span class="sd">        - ProximalJointPosition (Nx4)</span>
<span class="sd">        - DistalJointPosition (Nx4)</span>

<span class="sd">    inertial_constants</span>
<span class="sd">        A dict with at least a &#39;COMProximalRatio&#39; key, which is the distance</span>
<span class="sd">        between the segment&#39;s center of mass and the proximal joint, as a</span>
<span class="sd">        ratio of the distance between both joints.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TimeSeries</span>
<span class="sd">        A copy of the input timeseries plus the &#39;COMPosition&#39; data</span>
<span class="sd">        key.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;COMPosition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">inertial_constants</span><span class="p">[</span><span class="s1">&#39;COMProximalRatio&#39;</span><span class="p">]</span> <span class="o">*</span>
        <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DistalJointPosition&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalJointPosition&#39;</span><span class="p">])</span> <span class="o">+</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalJointPosition&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ts</span></div>


<div class="viewcode-block" id="calculate_com_acceleration"><a class="viewcode-back" href="../../api/kineticstoolkit.inversedynamics.calculate_com_acceleration.html#kineticstoolkit.inversedynamics.calculate_com_acceleration">[docs]</a><span class="nd">@unstable</span>
<span class="k">def</span> <span class="nf">calculate_com_acceleration</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TimeSeries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the acceleration of the segment&#39;s center of mass.</span>

<span class="sd">    Adds the data key &#39;COMAcceleration&#39; to the TimeSeries based on the</span>
<span class="sd">    specified filter function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts</span>
<span class="sd">        A TimeSeries with the at least a &#39;COMPosition&#39; data key.</span>

<span class="sd">    filter_func</span>
<span class="sd">        &#39;savgol&#39;: calculate the acceleration using the 2nd order coefficient</span>
<span class="sd">        of a moving polynomial.</span>
<span class="sd">        &#39;butter&#39;: no-lag 2nd order filter followed by a centered derivate.</span>

<span class="sd">    window_length</span>
<span class="sd">        Only for Savistky-Golay filters (savgol).</span>
<span class="sd">        The length of the filter window. window_length must be a positive</span>
<span class="sd">        odd integer less or equal than the length of the TimeSeries.</span>

<span class="sd">    poly_order</span>
<span class="sd">        Only for Savistky-Golay filters (savgol).</span>
<span class="sd">        Optional. The order of the polynomial used to fit the samples.</span>
<span class="sd">        polyorder must be less than window_length. The default is 2.</span>

<span class="sd">    fc</span>
<span class="sd">        Only for Butterworth filters (butter).</span>
<span class="sd">        Cut-off frequency in Hz.</span>
<span class="sd">    order</span>
<span class="sd">        Only for Butterworth filters (butter).</span>
<span class="sd">        Optional. Order of the filter. The default is 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TimeSeries</span>
<span class="sd">        A copy of the input timeseries plus the &#39;COMAcceleration&#39; data</span>
<span class="sd">        key.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">filter_func</span> <span class="o">==</span> <span class="s1">&#39;savgol&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;window_length&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;window_length must be specified for Savitzky-Golay filters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;poly_order&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">ts_com</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="s1">&#39;COMPosition&#39;</span><span class="p">)</span>
        <span class="n">ts_acc</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">savgol</span><span class="p">(</span>
            <span class="n">ts_com</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;window_length&#39;</span><span class="p">],</span>
            <span class="n">poly_order</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">],</span> <span class="n">deriv</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">elif</span> <span class="n">filter_func</span> <span class="o">==</span> <span class="s1">&#39;butter&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;fc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;fc must be specified for Butterworth filters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">ts_com</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="s1">&#39;COMPosition&#39;</span><span class="p">)</span>
        <span class="n">ts_acc</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span>
            <span class="n">ts_com</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fc&#39;</span><span class="p">],</span>
            <span class="n">order</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>

        <span class="n">ts_acc</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span><span class="n">ts_acc</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ts_acc</span> <span class="o">=</span> <span class="n">ts_acc</span><span class="o">.</span><span class="n">rename_data</span><span class="p">(</span><span class="s1">&#39;COMPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;COMAcceleration&#39;</span><span class="p">)</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ts_acc</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown filter type&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_segment_angles"><a class="viewcode-back" href="../../api/kineticstoolkit.inversedynamics.calculate_segment_angles.html#kineticstoolkit.inversedynamics.calculate_segment_angles">[docs]</a><span class="nd">@unstable</span>
<span class="k">def</span> <span class="nf">calculate_segment_angles</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TimeSeries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the segment&#39;s projection angles in the three axes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts</span>
<span class="sd">        A TimeSeries with the following data keys:</span>

<span class="sd">        - ProximalJointPosition (Nx4)</span>
<span class="sd">        - DistalJointPosition (Nx4)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TimeSeries</span>
<span class="sd">        A copy of the input timeseries plus the &#39;SegmentAngles&#39; data</span>
<span class="sd">        key, represented as an Nx3 numpy array.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">proximal_to_distal_joint_distance</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DistalJointPosition&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalJointPosition&#39;</span><span class="p">])</span>

    <span class="n">segment_angle_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">segment_angle_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">segment_angle_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SegmentAngles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
        <span class="n">segment_angle_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="n">segment_angle_y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="n">segment_angle_z</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ts</span></div>


<div class="viewcode-block" id="calculate_segment_rotation_rates"><a class="viewcode-back" href="../../api/kineticstoolkit.inversedynamics.calculate_segment_rotation_rates.html#kineticstoolkit.inversedynamics.calculate_segment_rotation_rates">[docs]</a><span class="nd">@unstable</span>
<span class="k">def</span> <span class="nf">calculate_segment_rotation_rates</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TimeSeries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the segments&#39; projected angular velocities and accelerations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts</span>
<span class="sd">        A TimeSeries with at least the &#39;SegmentAngles&#39; key (Nx3).</span>

<span class="sd">    filter_func</span>
<span class="sd">        &#39;savgol&#39;: calculate the velocity and acceleration using the 1st and</span>
<span class="sd">        2nd order coefficients of a moving polynomial.</span>
<span class="sd">        &#39;butter&#39;: no-lag 2nd order filter followed by centered derivates.</span>

<span class="sd">    window_length</span>
<span class="sd">        Only for Savitzky-Golay filters (savgol).</span>
<span class="sd">        The length of the filter window. window_length must be a positive</span>
<span class="sd">        odd integer less or equal than the length of the TimeSeries.</span>

<span class="sd">    poly_order</span>
<span class="sd">        Only for Savitzky-Golay filters (savgol).</span>
<span class="sd">        Optional. The order of the polynomial used to fit the samples.</span>
<span class="sd">        polyorder must be less than window_length. The default is 2.</span>

<span class="sd">    fc</span>
<span class="sd">        Only for Butterworth filters (butter).</span>
<span class="sd">        Cut-off frequency in Hz.</span>

<span class="sd">    order</span>
<span class="sd">        Only for Butterworth filters (butter).</span>
<span class="sd">        Optional. Order of the filter. The default is 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TimeSeries</span>
<span class="sd">        A copy of the input timeseries plus the &#39;AngularVelocity&#39; and</span>
<span class="sd">        &#39;AngularAcceleration&#39; data keys (each Nx3).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">filter_func</span> <span class="o">==</span> <span class="s1">&#39;savgol&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;window_length&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;window_length must be specified for Savitzky-Golay filters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;poly_order&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">ts_angle</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="s1">&#39;SegmentAngles&#39;</span><span class="p">)</span>
        <span class="n">ts_angvel</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">savgol</span><span class="p">(</span>
            <span class="n">ts_angle</span><span class="p">,</span>
            <span class="n">window_length</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;window_length&#39;</span><span class="p">],</span>
            <span class="n">poly_order</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">],</span> <span class="n">deriv</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ts_angacc</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">savgol</span><span class="p">(</span>
            <span class="n">ts_angle</span><span class="p">,</span>
            <span class="n">window_length</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;window_length&#39;</span><span class="p">],</span>
            <span class="n">poly_order</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">],</span> <span class="n">deriv</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;AngularVelocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_angvel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SegmentAngles&#39;</span><span class="p">]</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;AngularAcceleration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_angacc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SegmentAngles&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">elif</span> <span class="n">filter_func</span> <span class="o">==</span> <span class="s1">&#39;butter&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;fc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;fc must be specified for Butterworth filters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">ts_angle</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="s1">&#39;SegmentAngles&#39;</span><span class="p">)</span>
        <span class="n">ts_filt</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span>
            <span class="n">ts_angle</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fc&#39;</span><span class="p">],</span>
            <span class="n">order</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>

        <span class="n">ts_vel</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span><span class="n">ts_filt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ts_vel</span> <span class="o">=</span> <span class="n">ts_vel</span><span class="o">.</span><span class="n">rename_data</span><span class="p">(</span><span class="s1">&#39;SegmentAngles&#39;</span><span class="p">,</span> <span class="s1">&#39;AngularVelocity&#39;</span><span class="p">)</span>

        <span class="n">ts_acc</span> <span class="o">=</span> <span class="n">kineticstoolkit</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span><span class="n">ts_filt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ts_acc</span> <span class="o">=</span> <span class="n">ts_acc</span><span class="o">.</span><span class="n">rename_data</span><span class="p">(</span><span class="s1">&#39;SegmentAngles&#39;</span><span class="p">,</span> <span class="s1">&#39;AngularAcceleration&#39;</span><span class="p">)</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ts_vel</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ts_acc</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown filter type&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_proximal_wrench"><a class="viewcode-back" href="../../api/kineticstoolkit.inversedynamics.calculate_proximal_wrench.html#kineticstoolkit.inversedynamics.calculate_proximal_wrench">[docs]</a><span class="nd">@unstable</span>
<span class="k">def</span> <span class="nf">calculate_proximal_wrench</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span> <span class="n">inertial_constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TimeSeries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the proximal wrench based on a TimeSeries.</span>

<span class="sd">    This function is based on R. Dumas, R. Aissaoui, and J. A. De Guise,</span>
<span class="sd">    &quot;A 3D generic inverse dynamic method using wrench notation and quaternion</span>
<span class="sd">    algebra,” Comput Meth Biomech Biomed Eng, vol. 7, no. 3, pp. 159–166, 2004.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts</span>
<span class="sd">        A TimeSeries with the following data keys:</span>

<span class="sd">        - ProximalJointPosition (Nx4)</span>
<span class="sd">        - DistalJointPosition (Nx4)</span>
<span class="sd">        - ForceApplicationPosition (Nx4)</span>
<span class="sd">        - DistalForces (Nx4)</span>
<span class="sd">        - DistalMoments (Nx4)</span>

<span class="sd">        and these ones (although they can be reconstructed automatically by</span>
<span class="sd">        the function, in which case warnings are issued):</span>

<span class="sd">        - COMPosition (Nx4)</span>
<span class="sd">        - COMAcceleration (Nx4)</span>
<span class="sd">        - SegmentAngles (Nx3)</span>

<span class="sd">    inertial_constants</span>
<span class="sd">        A dict that contains the following keys:</span>

<span class="sd">        - &#39;Mass&#39;: Mass of the segment, in kg.</span>
<span class="sd">        - &#39;GyrationCOMRatio&#39;: Radius of gyration around the segment&#39;s</span>
<span class="sd">          center of mass, as a ratio of the distance between</span>
<span class="sd">          both joints.</span>

<span class="sd">        This dict may be generated using the get_anthropometrics function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TimeSeries</span>
<span class="sd">        A copy of the input timeseries plus these extra data keys:</span>

<span class="sd">        - &#39;ProximalForces&#39; (Nx4)</span>
<span class="sd">        - &#39;ProximalMoments&#39; (Nx4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">n_frames</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">proximal_to_distal_joint_distance</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DistalJointPosition&#39;</span><span class="p">]</span> <span class="o">-</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalJointPosition&#39;</span><span class="p">])</span>

    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RadiusOfGyration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RadiusOfGyration&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">inertial_constants</span><span class="p">[</span><span class="s1">&#39;GyrationCOMRatio&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RadiusOfGyration&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  \
        <span class="n">inertial_constants</span><span class="p">[</span><span class="s1">&#39;GyrationCOMRatio&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RadiusOfGyration&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  \
        <span class="n">inertial_constants</span><span class="p">[</span><span class="s1">&#39;GyrationCOMRatio&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
        <span class="n">proximal_to_distal_joint_distance</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Center of mass position and acceleration</span>
    <span class="k">if</span> <span class="s1">&#39;COMPosition&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">calculate_com_position</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">inertial_constants</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;COMPosition not found in input TimeSeries. I calculated it.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;COMAcceleration&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">calculate_com_acceleration</span><span class="p">(</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">filter_func</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">,</span>
            <span class="n">fc</span><span class="o">=</span><span class="n">default_filter_fc</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">default_filter_order</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;COMAcceleration not found in input TimeSeries. I calculated it &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;using a low-pass ButterWorth filter of order &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default_filter_order</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">default_filter_fc</span><span class="si">}</span><span class="s2"> Hz.&quot;</span><span class="p">)</span>

    <span class="c1"># Rotation angle, velocity and acceleration</span>

    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;AngularVelocity&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="s1">&#39;AngularAcceleration&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>

        <span class="c1"># Start by calculating the angles</span>
        <span class="k">if</span> <span class="s1">&#39;SegmentAngles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">calculate_segment_angles</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;SegmentAngles not found in input TimeSeries. I calculated it.&quot;</span><span class="p">)</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">calculate_segment_rotation_rates</span><span class="p">(</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">filter_func</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">,</span>
            <span class="n">fc</span><span class="o">=</span><span class="n">default_filter_fc</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">default_filter_order</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;COMAcceleration not found in input TimeSeries. I calculated it &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;using a low-pass ButterWorth filter of order &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default_filter_order</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">default_filter_fc</span><span class="si">}</span><span class="s2"> Hz.&quot;</span><span class="p">)</span>

    <span class="c1"># Forces line of the wrench equation (16)</span>
    <span class="n">a_i</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;COMAcceleration&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">F_i_minus_1</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DistalForces&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Moments line of the wrench equation (16)</span>
    <span class="n">c_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;COMPosition&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
           <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalJointPosition&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">d_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ForceApplicationPosition&#39;</span><span class="p">]</span> <span class="o">-</span>
           <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalJointPosition&#39;</span><span class="p">])[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">segment_mass</span> <span class="o">=</span> <span class="n">inertial_constants</span><span class="p">[</span><span class="s1">&#39;Mass&#39;</span><span class="p">]</span>
    <span class="n">I_i_temp</span> <span class="o">=</span> <span class="n">segment_mass</span> <span class="o">*</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RadiusOfGyration&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="c1"># Diagonalize I_i:</span>
    <span class="n">I_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">I_i</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_i_temp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">I_i</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_i_temp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">I_i</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_i_temp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;AngularAcceleration&#39;</span><span class="p">]</span>
    <span class="n">omega_i</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;AngularVelocity&#39;</span><span class="p">]</span>

    <span class="n">M_i_minus_1</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DistalMoments&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Calculation of the proximal wrench</span>
    <span class="n">proximal_wrench</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i_frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>

        <span class="n">skew_symmetric_c_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">c_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">c_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">c_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">c_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">c_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]])</span>

        <span class="n">skew_symmetric_d_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">d_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">d_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">d_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">d_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">d_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">d_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]])</span>

        <span class="n">matrix_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">segment_mass</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))],</span>
             <span class="p">[</span><span class="n">segment_mass</span> <span class="o">*</span> <span class="n">skew_symmetric_c_i</span><span class="p">,</span> <span class="n">I_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">]]])</span>

        <span class="n">matrix_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([</span><span class="n">a_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">]</span> <span class="o">-</span> <span class="n">g</span><span class="p">,</span> <span class="n">alpha_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">]])</span>
        <span class="n">matrix_2</span> <span class="o">=</span> <span class="n">matrix_2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Convert 1d to column vector</span>

        <span class="n">matrix_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">omega_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">],</span> <span class="n">I_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">]</span> <span class="o">@</span> <span class="n">omega_i</span><span class="p">[</span><span class="n">i_frame</span><span class="p">])])</span>
        <span class="n">matrix_3</span> <span class="o">=</span> <span class="n">matrix_3</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Convert 1d to column vector</span>

        <span class="n">matrix_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))],</span>
            <span class="p">[</span><span class="n">skew_symmetric_d_i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)]])</span>

        <span class="n">matrix_5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([</span><span class="n">F_i_minus_1</span><span class="p">[</span><span class="n">i_frame</span><span class="p">],</span> <span class="n">M_i_minus_1</span><span class="p">[</span><span class="n">i_frame</span><span class="p">]])</span>
        <span class="n">matrix_5</span> <span class="o">=</span> <span class="n">matrix_5</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Convert 1d to column vector</span>

        <span class="n">proximal_wrench</span><span class="p">[</span><span class="n">i_frame</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">matrix_1</span> <span class="o">@</span> <span class="n">matrix_2</span> <span class="o">+</span> <span class="n">matrix_3</span> <span class="o">+</span> <span class="n">matrix_4</span> <span class="o">@</span> <span class="n">matrix_5</span><span class="p">)</span>

    <span class="c1"># Initialize to a series of vectors of length 4</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalForces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalMoments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="c1"># Assign the 3 first components of the vectors</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalForces&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">proximal_wrench</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ProximalMoments&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">proximal_wrench</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ts</span></div>


<span class="n">module_locals</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>


<span class="k">def</span> <span class="fm">__dir__</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">directory</span><span class="p">(</span><span class="n">module_locals</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>